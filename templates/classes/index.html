{% extends "layout.html" %}

{% block title %}Classes & Instructors{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">

    <!-- Left Column: Classes List -->
    <div>
        <div class="glass-card">
            <h2 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">Active
                Classes</h2>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="color: var(--text-muted);">Manage your weekly class schedule</span>
                {% if current_user.role == 'Admin' %}
                <form method="post" action="{{ url_for('classes.delete_all') }}" style="display: inline;"
                    onsubmit="return confirm('⚠️ DANGER: This will permanently delete ALL classes, enrollments, and attendance records.\n\nType DELETE in the next prompt to confirm.') && prompt('Type DELETE to confirm:') === 'DELETE';">
                    <button type="submit" class="btn-icon"
                        style="background: #dc2626; color: white; padding: 0.8rem 1.2rem; border-radius: 8px; width: auto; height: auto;"
                        title="Delete All Classes">
                        <i class="fas fa-trash-alt"></i> Delete All Classes
                    </button>
                </form>
                {% endif %}
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                {% for cls in classes %}
                <div
                    style="background: var(--bg-dark); padding: 1rem; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">{{ cls.name }}</h3>
                        <a href="{{ url_for('classes.delete_class', id=cls.id) }}" style="color: #ef4444;"><i
                                class="fas fa-trash"></i></a>
                    </div>

                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-clock"></i> {{ cls.schedule }}
                    </p>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; font-size: 0.85rem;">
                        <span
                            style="background: rgba(99, 102, 241, 0.2); color: var(--primary); padding: 2px 8px; border-radius: 6px;">
                            {{ cls.instructor.name if cls.instructor else 'No Instructor' }}
                        </span>
                        <span style="color: var(--text-muted);">
                            <i class="fas fa-users"></i> {{ cls.enrollments|length }} / {{ cls.capacity if cls.capacity
                            else '∞' }}
                        </span>
                    </div>

                    <!-- Enrolled Students List -->
                    <div style="margin-top: 1rem; background: rgba(0,0,0,0.1); border-radius: 8px; padding: 0.5rem;">
                        <h4
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">
                            Enrolled Students</h4>
                        <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.8rem;">
                            {% for enr in cls.enrollments %}
                            <li style="display: flex; justify-content: space-between; margin-bottom: 0.2rem;">
                                <span>{{ enr.student.name }}</span>
                                <a href="{{ url_for('classes.unenroll_student', enrollment_id=enr.id) }}"
                                    style="color: #ef4444; opacity: 0.5;" title="Unenroll"><i
                                        class="fas fa-times-circle"></i></a>
                            </li>
                            {% else %}
                            <li style="color: var(--text-muted); font-size: 0.75rem; font-style: italic;">No students
                                enrolled yet.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% else %}
                <p style="color: var(--text-muted);">No classes scheduled yet.</p>
                {% endfor %}
            </div>

            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 2rem;">
                <!-- Add Class Form -->
                <div>
                    <h3 style="margin-bottom: 1rem;">Schedule New Class</h3>
                    <form action="{{ url_for('classes.add_class') }}" method="post" style="display: grid; gap: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="text" name="name" placeholder="Class Name (e.g., Jazz Batch A)" required>
                            <select name="instructor_id">
                                <option value="">-- Select Instructor --</option>
                                {% for inst in instructors %}
                                <option value="{{ inst.id }}">{{ inst.name }} ({{ inst.specialty }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                            <input type="text" name="schedule" placeholder="Schedule (e.g., Mon, Wed 5PM)" required>
                            <input type="number" name="capacity" placeholder="Capacity (Optional)">
                        </div>
                        <button type="submit" class="btn-primary">Create Class</button>
                    </form>
                </div>

                <!-- Enroll Student Form -->
                <div
                    style="background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem;">Enroll Student</h3>
                    <form action="{{ url_for('classes.enroll_student') }}" method="post"
                        style="display: grid; gap: 1rem;">
                        <label style="font-size: 0.85rem; color: var(--text-muted);">Select Student</label>
                        <select name="student_id" required>
                            <option value="">-- Choose Student --</option>
                            {% for s in students %}
                            <option value="{{ s.id }}">{{ s.name }} ({{ s.phone }})</option>
                            {% endfor %}
                        </select>

                        <label style="font-size: 0.85rem; color: var(--text-muted);">Select Class</label>
                        <select name="class_id" required>
                            <option value="">-- Choose Class --</option>
                            {% for c in classes %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>

                        <button type="submit" class="btn-primary" style="background: var(--primary);">Enroll
                            Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Instructors -->
    <div>
        <div class="glass-card">
            <h2 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">Instructors
            </h2>

            <!-- Scrollable List Wrapper -->
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 2rem; padding-right: 5px;">
                <ul style="list-style: none;">
                    {% for inst in instructors %}
                    <li style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; padding: 0.5rem; border-radius: 8px; transition: 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.02)'"
                        onmouseout="this.style.background='transparent'">
                        <div
                            style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            {% if inst.photo_path %}
                            <img src="{{ url_for('static', filename=inst.photo_path) }}"
                                style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-muted);">{{ inst.name[0]
                                }}</span>
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight: 500;">{{ inst.name }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">{{ inst.specialty }}</div>
                        </div>

                        <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                            <!-- View Details Button -->
                            <button class="btn-icon"
                                onclick='openInstructorModal({{ inst.name|tojson }}, {{ inst.phone|tojson }}, {{ inst.specialty|tojson }}, {{ inst.citizenship_no|tojson }}, {{ inst.photo_path|tojson }}, {{ inst.document_path|tojson }})'
                                title="View Details" style="color: var(--primary);">
                                <i class="fas fa-eye"></i>
                            </button>

                            <a href="{{ url_for('classes.delete_instructor', id=inst.id) }}"
                                style="color: #ef4444; opacity: 0.7; transition: opacity 0.2s; display: flex; align-items: center;"
                                onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"
                                onclick="return confirm('Delete instructor {{ inst.name }}?');">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </li>
                    {% else %}
                    <li style="color: var(--text-muted);">No instructors added.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Add Instructor Form -->
            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Add Instructor</h3>
            <form action="{{ url_for('classes.add_instructor') }}" method="post" enctype="multipart/form-data"
                style="display: grid; gap: 0.8rem;">
                <input type="text" name="name" placeholder="Name" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <input type="text" name="specialty" placeholder="Specialty (e.g., Ballet)">
                <input type="text" name="citizenship_no" placeholder="Citizenship No">

                <div style="font-size: 0.8rem;">
                    <label style="color: var(--text-muted); display: block; margin-bottom: 0.2rem;">Photo
                        (Optional)</label>
                    <input type="file" name="photo" accept="image/*" style="padding: 0.5rem;">
                </div>

                <div style="font-size: 0.8rem;">
                    <label style="color: var(--text-muted); display: block; margin-bottom: 0.2rem;">Documents
                        (Optional)</label>
                    <input type="file" name="document" style="padding: 0.5rem;">
                </div>

                <button type="submit" class="btn-primary" style="font-size: 0.9rem;">Add Instructor</button>
            </form>
        </div>
    </div>
</div>

<!-- Instructor Details Modal -->
<div id="instructor-modal" class="modal-overlay" style="display: none;"
    onclick="if(event.target == this) closeInstructorModal()">
    <div class="glass-card" style="width: 400px; max-width: 90%; background: var(--bg-card); position: relative;">
        <button onclick="closeInstructorModal()"
            style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">
            <i class="fas fa-times"></i>
        </button>

        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div id="modal-photo-container"
                style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-dark); margin: 0 auto 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
                <!-- Img injected via JS -->
            </div>
            <h2 id="modal-name" style="margin-bottom: 0.2rem;"></h2>
            <div id="modal-specialty" style="color: var(--primary); font-size: 0.9rem;"></div>
        </div>

        <div style="display: grid; gap: 1rem; font-size: 0.9rem;">
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Phone</span>
                <span id="modal-phone" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Citizenship No</span>
                <span id="modal-citizenship" style="font-weight: 500;"></span>
            </div>

            <div id="modal-doc-container" style="margin-top: 1rem; text-align: center; display: none;">
                <a id="modal-doc-link" href="#" target="_blank" class="btn-primary"
                    style="display: inline-block; width: 100%; text-align: center;">
                    <i class="fas fa-file-alt"></i> View/Download Document
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function openInstructorModal(name, phone, specialty, citizenship, photoPath, docPath) {
        document.getElementById('modal-name').innerText = name;
        document.getElementById('modal-phone').innerText = phone;
        document.getElementById('modal-specialty').innerText = specialty;
        document.getElementById('modal-citizenship').innerText = citizenship || 'N/A';

        // Handle Photo
        const photoContainer = document.getElementById('modal-photo-container');
        if (photoPath) {
            photoContainer.innerHTML = `<img src="/static/${photoPath}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            photoContainer.innerHTML = `<span style="font-size: 2rem; font-weight: 600; color: var(--text-muted);">${name.charAt(0)}</span>`;
        }

        // Handle Document
        const docContainer = document.getElementById('modal-doc-container');
        const docLink = document.getElementById('modal-doc-link');

        if (docPath) {
            docContainer.style.display = 'block';
            docLink.href = `/static/${docPath}`;
        } else {
            docContainer.style.display = 'none';
        }

        document.getElementById('instructor-modal').style.display = 'flex';
    }

    function closeInstructorModal() {
        document.getElementById('instructor-modal').style.display = 'none';
    }

    // Close on escape
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeInstructorModal();
        }
    });
</script>

{% endblock %}