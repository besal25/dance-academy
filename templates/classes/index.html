{% extends "layout.html" %}

{% block title %}Classes & Instructors{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 2rem;">

    <!-- Top Section: Header & Actions -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h2 style="margin: 0; color: var(--text-main);">Classes & Instructors</h2>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Manage schedules and faculty.</p>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button onclick="openAddClassModal()" class="btn-primary"
                style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-plus-circle"></i> New Class
            </button>
            <button onclick="openAddInstructorModal()" class="btn-primary"
                style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-plus"></i> Add Instructor
            </button>
            {% if current_user.role == 'Admin' %}
            <form method="post" action="{{ url_for('classes.delete_all') }}" style="display: inline;"
                onsubmit="return confirm('⚠️ DANGER: This will permanently delete ALL classes, enrollments, and attendance records.\n\nType DELETE to confirm.') && prompt('Type DELETE to confirm:') === 'DELETE';">
                <button type="submit" class="btn-icon"
                    style="background: rgba(220, 38, 38, 0.1); color: #ef4444; width: auto; height: auto; padding: 0.8rem 1.2rem; border-color: rgba(220, 38, 38, 0.2);"
                    title="Delete All Data">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 2rem;">

        <!-- LEFT: Classes Grid -->
        <div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                {% for cls in classes %}
                <div class="glass-card"
                    style="padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 100%;">

                    <!-- Card Header -->
                    <div
                        style="padding: 1.5rem; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">{{ cls.name }}</h3>
                            <button onclick="openManageClassModal({{ cls.id|tojson }}, {{ cls.name|tojson }})"
                                class="btn-icon" style="width: 32px; height: 32px;" title="Manage Class">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                            <i class="fas fa-chalkboard-teacher" style="color: var(--primary);"></i>
                            {{ cls.instructor.name if cls.instructor else 'No Instructor' }}
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div style="padding: 1.5rem; flex: 1;">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                            <i class="fas fa-clock"></i> {{ cls.schedule }}
                        </div>

                        <!-- Enrollment Progress -->
                        <div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.3rem;">
                                <span style="color: var(--text-muted);">Capacity</span>
                                <span style="font-weight: 600; color: var(--primary);">
                                    {{ cls.enrollments|length }} / {{ cls.capacity if cls.capacity else '∞' }}
                                </span>
                            </div>
                            <div
                                style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                {% set cap = cls.capacity if cls.capacity else 20 %}
                                {% set pct = (cls.enrollments|length / cap * 100)|round|int %}
                                <div style="width: {{ pct }}%; height: 100%; background: var(--primary);"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Footer -->
                    <div
                        style="padding: 1rem; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); text-align: center;">
                        <button onclick="openManageClassModal({{ cls.id|tojson }}, {{ cls.name|tojson }})"
                            class="btn-primary"
                            style="width: 100%; background: transparent; border: 1px dashed var(--border); color: var(--text-muted);">
                            Manage & Enroll
                        </button>
                    </div>

                    <!-- Hidden Data for JS Modal Populating -->
                    <div id="enrolled-{{ cls.id }}" style="display: none;">
                        {% for enr in cls.enrollments %}
                        <div data-id="{{ enr.id }}" data-name="{{ enr.student.name }}"
                            data-phone="{{ enr.student.phone }}"></div>
                        {% endfor %}
                    </div>

                </div>
                {% else %}
                <div
                    style="grid-column: 1 / -1; text-align: center; padding: 4rem; color: var(--text-muted); border: 2px dashed var(--border); border-radius: 12px;">
                    <i class="fas fa-users-slash" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>No classes found. Create one to get started!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- RIGHT: Instructors List -->
        <div>
            <div class="glass-card" style="padding: 1.5rem;">
                <h3
                    style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">
                    Instructors</h3>

                <div style="max-height: 600px; overflow-y: auto; padding-right: 5px;">
                    {% for inst in instructors %}
                    <div
                        style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                        <div onclick='openInstructorModal({{ inst.name|tojson }}, {{ inst.phone|tojson }}, {{ inst.specialty|tojson }}, {{ inst.citizenship_no|tojson }}, {{ inst.photo_path|tojson }}, {{ inst.document_path|tojson }})'
                            style="cursor: pointer; width: 45px; height: 45px; border-radius: 50%; background: var(--bg-dark); overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
                            {% if inst.photo_path %}
                            <img src="{{ url_for('static', filename=inst.photo_path) }}"
                                style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                            <span style="font-weight: 600; color: var(--text-muted);">{{ inst.name[0] }}</span>
                            {% endif %}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.95rem;">{{ inst.name }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">{{ inst.specialty }}</div>
                        </div>
                        <a href="{{ url_for('classes.delete_instructor', id=inst.id) }}" class="btn-icon"
                            style="width: 30px; height: 30px; color: #ef4444; border: none;"
                            onclick="return confirm('Delete {{ inst.name }}?');" title="Delete">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                    {% else %}
                    <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem;">No instructors.</p>
                    {% endfor %}
                </div>

                <button onclick="openAddInstructorModal()" class="btn-primary"
                    style="width: 100%; margin-top: 1rem; background: rgba(99, 102, 241, 0.1); border: 1px dashed var(--primary); color: var(--primary);">
                    <i class="fas fa-plus"></i> Add New
                </button>
            </div>
        </div>

    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- 1. Add Class Modal -->
<div id="add-class-modal" class="modal-overlay" style="display: none;" onclick="if(event.target == this) closeModals()">
    <div class="glass-card" style="width: 500px; max-width: 90%; background: var(--bg-card);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">Create New Class</h3>
            <button onclick="closeModals()" class="btn-icon" style="border: none;"><i class="fas fa-times"></i></button>
        </div>

        <form action="{{ url_for('classes.add_class') }}" method="post"
            style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Class Name</label>
                <input type="text" name="name" placeholder="e.g. Hip Hop Beginners" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Instructor</label>
                    <select name="instructor_id">
                        <option value="">-- Select --</option>
                        {% for inst in instructors %}
                        <option value="{{ inst.id }}">{{ inst.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Capacity</label>
                    <input type="number" name="capacity" placeholder="Optional">
                </div>
            </div>

            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Schedule</label>
                <input type="text" name="schedule" placeholder="e.g. Mon, Wed 5PM - 6PM" required>
            </div>

            <button type="submit" class="btn-primary" style="margin-top: 0.5rem;">Create Class</button>
        </form>
    </div>
</div>

<!-- 2. Add Instructor Modal -->
<div id="add-instructor-modal" class="modal-overlay" style="display: none;"
    onclick="if(event.target == this) closeModals()">
    <div class="glass-card" style="width: 500px; max-width: 90%; background: var(--bg-card);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">Add New Instructor</h3>
            <button onclick="closeModals()" class="btn-icon" style="border: none;"><i class="fas fa-times"></i></button>
        </div>

        <form action="{{ url_for('classes.add_instructor') }}" method="post" enctype="multipart/form-data"
            style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Full Name</label>
                <input type="text" name="name" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Phone</label>
                    <input type="tel" name="phone" required placeholder="10-digit mobile">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Specialty</label>
                    <input type="text" name="specialty" placeholder="e.g. Contemporary">
                </div>
            </div>

            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Citizenship No
                    (Optional)</label>
                <input type="text" name="citizenship_no">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Photo</label>
                    <input type="file" name="photo" accept="image/*" style="font-size: 0.9rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Document</label>
                    <input type="file" name="document" style="font-size: 0.9rem;">
                </div>
            </div>

            <button type="submit" class="btn-primary" style="margin-top: 0.5rem;">Save Instructor</button>
        </form>
    </div>
</div>

<!-- 3. Manage Class Modal (Enroll/Unenroll) -->
<div id="manage-class-modal" class="modal-overlay" style="display: none;"
    onclick="if(event.target == this) closeModals()">
    <div class="glass-card" style="width: 600px; max-width: 90%; background: var(--bg-card);">
        <div
            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
            <div>
                <h3 id="manage-class-name" style="margin: 0; color: var(--primary);">Class Name</h3>
                <span class="badge" style="margin-top: 0.5rem; display: inline-block;">Managing Enrollments</span>
            </div>
            <button onclick="closeModals()" class="btn-icon" style="border: none;"><i class="fas fa-times"></i></button>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1.5rem;">

            <!-- Enroll New Student -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px dashed var(--border);">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Enroll Student</label>
                <form action="{{ url_for('classes.enroll_student') }}" method="post"
                    style="display: flex; gap: 0.8rem;">
                    <input type="hidden" name="class_id" id="manage-class-id">
                    <select name="student_id" required style="flex: 1;">
                        <option value="">-- Select Student --</option>
                        {% for s in students %}
                        <option value="{{ s.id }}">{{ s.name }} ({{ s.phone }})</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn-primary">Enroll</button>
                </form>
            </div>

            <!-- List of Enrolled -->
            <div>
                <h4 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-muted);">Enrolled Students</h4>
                <div id="manage-enrolled-list"
                    style="max-height: 200px; overflow-y: auto; background: var(--bg-dark); border-radius: 8px;">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- Delete Class -->
            <div style="text-align: right; border-top: 1px solid var(--border); padding-top: 1rem;">
                <a id="manage-delete-btn" href="#" class="btn-icon"
                    style="color: #ef4444; width: auto; padding: 0.5rem 1rem; display: inline-flex; align-items: center; gap: 0.5rem;"
                    onclick="return confirm('WARNING: Are you sure you want to delete this class?');">
                    <i class="fas fa-trash-alt"></i> Delete Class
                </a>
            </div>

        </div>
    </div>
</div>

<!-- 4. Instructor Details Modal -->
<div id="instructor-modal" class="modal-overlay" style="display: none;"
    onclick="if(event.target == this) closeModals()">
    <div class="glass-card" style="width: 400px; max-width: 90%; background: var(--bg-card); position: relative;">
        <button onclick="closeModals()"
            style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">
            <i class="fas fa-times"></i>
        </button>

        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div id="modal-inst-photo"
                style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-dark); margin: 0 auto 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
            </div>
            <h2 id="modal-inst-name" style="margin-bottom: 0.2rem;"></h2>
            <div id="modal-inst-specialty" style="color: var(--primary); font-size: 0.9rem;"></div>
        </div>

        <div style="display: grid; gap: 1rem; font-size: 0.9rem;">
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Phone</span>
                <span id="modal-inst-phone" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Citizenship No</span>
                <span id="modal-inst-citizenship" style="font-weight: 500;"></span>
            </div>
            <div id="modal-inst-doc-container" style="margin-top: 1rem; text-align: center; display: none;">
                <a id="modal-inst-doc-link" href="#" target="_blank" class="btn-primary"
                    style="display: inline-block; width: 100%; text-align: center;">
                    <i class="fas fa-file-alt"></i> View Document
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // General Modal Closer
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    }

    // Add Class Modal
    function openAddClassModal() {
        closeModals();
        document.getElementById('add-class-modal').style.display = 'flex';
    }

    // Add Instructor Modal
    function openAddInstructorModal() {
        closeModals();
        document.getElementById('add-instructor-modal').style.display = 'flex';
    }

    // Manage Class Modal
    function openManageClassModal(id, name) {
        closeModals();

        document.getElementById('manage-class-name').innerText = name;
        document.getElementById('manage-class-id').value = id;
        document.getElementById('manage-delete-btn').href = "/classes/delete/" + id;

        // Populate Student List from hidden data div
        const listContainer = document.getElementById('manage-enrolled-list');
        listContainer.innerHTML = '';

        const dataDiv = document.getElementById('enrolled-' + id);
        const enrolled = dataDiv.querySelectorAll('div');

        if (enrolled.length === 0) {
            listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">No students enrolled.</div>';
        } else {
            enrolled.forEach(div => {
                const sId = div.getAttribute('data-id'); // Enrollment ID
                const sName = div.getAttribute('data-name');
                const sPhone = div.getAttribute('data-phone');

                const item = document.createElement('div');
                item.style.padding = '0.8rem';
                item.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';

                item.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${sName}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${sPhone}</div>
                    </div>
                    <a href="/classes/unenroll/${sId}" style="color: #ef4444; opacity: 0.6; padding: 0.2rem;" title="Unenroll">
                        <i class="fas fa-minus-circle"></i>
                    </a>
                `;
                listContainer.appendChild(item);
            });
        }

        document.getElementById('manage-class-modal').style.display = 'flex';
    }

    // Instructor Details Modal
    function openInstructorModal(name, phone, specialty, citizenship, photoPath, docPath) {
        closeModals();
        document.getElementById('modal-inst-name').innerText = name;
        document.getElementById('modal-inst-phone').innerText = phone;
        document.getElementById('modal-inst-specialty').innerText = specialty;
        document.getElementById('modal-inst-citizenship').innerText = citizenship || 'N/A';

        const photoContainer = document.getElementById('modal-inst-photo');
        if (photoPath) {
            photoContainer.innerHTML = `<img src="/static/${photoPath}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            photoContainer.innerHTML = `<span style="font-size: 2rem; font-weight: 600; color: var(--text-muted);">${name.charAt(0)}</span>`;
        }

        const docContainer = document.getElementById('modal-inst-doc-container');
        if (docPath) {
            docContainer.style.display = 'block';
            document.getElementById('modal-inst-doc-link').href = `/static/${docPath}`;
        } else {
            docContainer.style.display = 'none';
        }

        document.getElementById('instructor-modal').style.display = 'flex';
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") closeModals();
    });
</script>
{% endblock %}