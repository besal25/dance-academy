{% extends "layout.html" %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="glass-card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">

        <div style="display: flex; align-items: center; gap: 1rem;">
            <h2 style="margin: 0; color: var(--text-main);">Students</h2>
            <span class="badge"
                style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); font-size: 0.8rem; padding: 0.3rem 0.8rem;">
                Total: {{ students|length }}
            </span>
        </div>

        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
            <form action="{{ url_for('students.index') }}" method="get"
                style="display: flex; gap: 0.5rem; align-items: center; background: var(--bg-dark); padding: 0.3rem; border-radius: 8px; border: 1px solid var(--border);">
                <i class="fas fa-search" style="color: var(--text-muted); padding-left: 0.5rem;"></i>
                <input type="text" name="search" placeholder="Search..." value="{{ search }}"
                    style="border: none; background: transparent; padding: 0.5rem; width: 200px; outline: none;">
                <button type="submit" class="btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Go</button>
            </form>

            <a href="{{ url_for('students.add') }}" class="btn-primary"><i class="fas fa-plus"></i> Add New</a>

            {% if current_user.role == 'Admin' %}
            <form method="post" action="{{ url_for('students.delete_all') }}" style="display: inline;"
                onsubmit="return confirm('⚠️ DANGER: This will permanently delete ALL students and ALL related records.\n\nType DELETE to confirm.') && prompt('Type DELETE to confirm:') === 'DELETE';">
                <button type="submit" class="btn-icon"
                    style="background: rgba(220, 38, 38, 0.1); color: #ef4444; border-color: rgba(220, 38, 38, 0.2);"
                    title="Delete All">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="table-scroll-wrapper">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0; color: var(--text-main);">
            <thead>
                <tr style="text-align: left; background: rgba(255,255,255,0.02);">
                    <th
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted);">
                        Profile</th>
                    <th
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted);">
                        Status</th>
                    <th
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted);">
                        Fee</th>
                    <th
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted);">
                        Balance</th>
                    <th
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted); text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr style="transition: background 0.2s; border-bottom: 1px solid var(--border);">
                    <!-- Profile (Name + Phone) -->
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div
                                style="width: 42px; height: 42px; border-radius: 12px; background: var(--bg-dark); overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border);">
                                {% if student.photo_path %}
                                <img src="{{ url_for('static', filename=student.photo_path) }}"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                <span style="font-weight: 600; color: var(--text-muted); font-size: 1.1rem;">{{
                                    student.name[0] }}</span>
                                {% endif %}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.95rem;">{{ student.name }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);"><i class="fas fa-phone-alt"
                                        style="font-size: 0.7rem;"></i> {{ student.phone }}</div>
                            </div>
                        </div>
                    </td>

                    <!-- Status -->
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <span
                            style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500;
                            background: {{ 'rgba(16, 185, 129, 0.1)' if student.status == 'Active' else 'rgba(239, 68, 68, 0.1)' }};
                            color: {{ '#34d399' if student.status == 'Active' else '#f87171' }}; border: 1px solid {{ 'rgba(16, 185, 129, 0.2)' if student.status == 'Active' else 'rgba(239, 68, 68, 0.2)' }};">
                            <span style="width: 6px; height: 6px; border-radius: 50%; background: currentColor;"></span>
                            {{ student.status }}
                        </span>
                    </td>

                    <!-- Fee -->
                    <td
                        style="padding: 1rem; border-bottom: 1px solid var(--border); font-family: monospace; font-size: 0.95rem;">
                        Rs {{ "%.0f"|format(student.custom_monthly_fee) }}
                    </td>

                    <!-- Balance -->
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        {% set bal = student.get_balance() %}
                        <span style="font-weight: 600; font-family: monospace; font-size: 0.95rem;
                            color: {{ '#ef4444' if bal > 0 else '#34d399' }}">
                            {{ "Rs %.2f"|format(bal) if bal >= 0 else "Rs %.2f (Adv)"|format(bal|abs) }}
                        </span>
                    </td>

                    <!-- Actions -->
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; gap: 0.3rem; justify-content: flex-end;">
                            <button class="btn-icon" style="width: 32px; height: 32px;"
                                onclick='openStudentModal({{ student.id|tojson }}, {{ student.name|tojson }}, {{ student.phone|tojson }}, {{ student.status|tojson }}, {{ student.dob|tojson }}, {{ student.guardian_name|tojson }}, {{ student.emergency_contact|tojson }}, {{ student.photo_path|tojson }}, {{ student.custom_monthly_fee|tojson }}, {{ student.last_admission_date|tojson }})'
                                title="Quick View">
                                <i class="fas fa-eye" style="font-size: 0.9rem;"></i>
                            </button>

                            <a href="{{ url_for('students.progress', id=student.id) }}" class="btn-icon"
                                style="width: 32px; height: 32px; color: #f59e0b; border-color: rgba(245, 158, 11, 0.3);"
                                title="Progress">
                                <i class="fas fa-chart-line" style="font-size: 0.9rem;"></i>
                            </a>

                            <a href="{{ url_for('finance.student_ledger', student_id=student.id) }}" class="btn-icon"
                                style="width: 32px; height: 32px; color: #6366f1; border-color: rgba(99, 102, 241, 0.3);"
                                title="Ledger">
                                <i class="fas fa-wallet" style="font-size: 0.9rem;"></i>
                            </a>

                            <a href="{{ url_for('students.edit', id=student.id) }}" class="btn-icon"
                                style="width: 32px; height: 32px;" title="Edit">
                                <i class="fas fa-edit" style="font-size: 0.9rem;"></i>
                            </a>

                            <a href="{{ url_for('students.delete', id=student.id) }}" class="btn-icon"
                                style="width: 32px; height: 32px; color: #ef4444; border-color: rgba(239, 68, 68, 0.3);"
                                title="Delete" onclick="return confirm('Delete {{ student.name }}?');">
                                <i class="fas fa-trash" style="font-size: 0.9rem;"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="padding: 3rem; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No students found matching your criteria.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Student Details Modal -->
<div id="student-modal" class="modal-overlay" style="display: none;"
    onclick="if(event.target == this) closeStudentModal()">
    <div class="glass-card" style="width: 400px; max-width: 90%; background: var(--bg-card); position: relative;">
        <button onclick="closeStudentModal()"
            style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">
            <i class="fas fa-times"></i>
        </button>

        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div id="modal-photo-container"
                style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-dark); margin: 0 auto 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);">
                <!-- Img injected via JS -->
            </div>
            <h2 id="modal-name" style="margin-bottom: 0.2rem;"></h2>
            <div id="modal-status" style="font-size: 0.9rem;"></div>
        </div>

        <div style="display: grid; gap: 1rem; font-size: 0.9rem;">
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Phone</span>
                <span id="modal-phone" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">DOB (BS)</span>
                <span id="modal-dob" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Guardian</span>
                <span id="modal-guardian" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Emergency Contact</span>
                <span id="modal-emergency" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Joined (BS)</span>
                <span id="modal-joined" style="font-weight: 500;"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-muted);">Monthly Fee</span>
                <span id="modal-fee" style="font-weight: 500;"></span>
            </div>
        </div>


    </div>
</div>

<script>
    function openStudentModal(id, name, phone, status, dob, guardian, emergency, photoPath, fee, joined) {
        document.getElementById('modal-name').innerText = name;
        document.getElementById('modal-phone').innerText = phone;
        document.getElementById('modal-dob').innerText = dob || 'N/A';
        document.getElementById('modal-guardian').innerText = guardian || 'N/A';
        document.getElementById('modal-emergency').innerText = emergency || 'N/A';
        document.getElementById('modal-fee').innerText = 'Rs ' + (fee ? parseFloat(fee).toFixed(2) : '0.00');
        document.getElementById('modal-joined').innerText = joined || 'N/A';

        const statusEl = document.getElementById('modal-status');
        statusEl.innerText = status;
        statusEl.style.color = status === 'Active' ? '#34d399' : '#f87171';

        // Handle Photo
        const photoContainer = document.getElementById('modal-photo-container');
        if (photoPath) {
            photoContainer.innerHTML = `<img src="/static/${photoPath}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            photoContainer.innerHTML = `<span style="font-size: 2rem; font-weight: 600; color: var(--text-muted);">${name.charAt(0)}</span>`;
        }

        document.getElementById('student-modal').style.display = 'flex';
    }

    function closeStudentModal() {
        document.getElementById('student-modal').style.display = 'none';
    }

    // Close on escape
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeStudentModal();
        }
    });
</script>

{% endblock %}