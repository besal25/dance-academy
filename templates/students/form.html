{% extends "layout.html" %}

{% block title %}{{ 'Edit Student' if student else 'New Student' }}
<script>
    function previewImage(input) {
        const container = document.getElementById('photo-preview-container');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                container.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function toggleDiscount(value) {
        const discDiv = document.getElementById('discount_div');
        const fixedDiv = document.getElementById('fixed_amount_div');

        if (discDiv) discDiv.style.display = (value === 'Percentage') ? 'block' : 'none';
        if (fixedDiv) fixedDiv.style.display = (value === 'Fixed') ? 'block' : 'none';
    }
</script>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h2 style="margin-bottom: 1.5rem; text-align: center; color: var(--text-main);">
        <i class="fas fa-user-graduate" style="color: var(--primary); margin-right: 0.5rem;"></i>
        {{ 'Edit Student' if student else 'Register New Student' }}
    </h2>

    <form method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 2rem;">

        <!-- Section 1: Identity -->
        <div class="glass-card" style="padding: 2rem;">
            <h4
                style="margin-top: 0; margin-bottom: 1.5rem; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                <i class="fas fa-id-card"></i> Identity & Photo
            </h4>

            <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                <!-- Photo Upload with Preview -->
                <div style="flex: 0 0 auto; text-align: center;">
                    <div id="photo-preview-container"
                        style="width: 140px; height: 140px; border-radius: 50%; background: var(--bg-dark); border: 2px dashed var(--border); margin: 0 auto 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative;">
                        {% if student and student.photo_path %}
                        <img src="{{ url_for('static', filename=student.photo_path) }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <i class="fas fa-camera" style="font-size: 2.5rem; color: var(--text-muted); opacity: 0.5;"></i>
                        {% endif %}
                    </div>
                    <label class="btn-primary"
                        style="background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-upload"></i> Upload
                        <input type="file" name="photo" accept="image/*" style="display: none;"
                            onchange="previewImage(this)">
                    </label>
                </div>

                <!-- Basic Info -->
                <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Full
                            Name *</label>
                        <input type="text" name="name" value="{{ student.name if student else '' }}" required
                            placeholder="e.g. Aarav Sharma" style="font-size: 1.1rem; padding: 1rem;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Date
                                of Birth (BS)</label>
                            <input type="text" name="dob" class="nepali-date-picker" value="{{ student.dob or '' }}"
                                placeholder="YYYY-MM-DD">
                        </div>

                        <div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Admission
                                Date (BS)</label>
                            <input type="text" name="last_admission_date" class="nepali-date-picker"
                                value="{{ student.last_admission_date or '' }}" placeholder="YYYY-MM-DD">
                        </div>

                        <div>
                            <label
                                style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Status</label>
                            <select name="status" style="width: 100%;">
                                <option value="Active" {{ 'selected' if student and student.status=='Active'
                                    else 'selected' }}>Active</option>
                                <option value="Inactive" {{ 'selected' if student and student.status=='Inactive' else ''
                                    }}>Inactive</option>
                            </select>
                        </div>
                    </div>


                </div>
            </div>
        </div>

        <!-- Section 2: Contact Info -->
        <div class="glass-card" style="padding: 2rem;">
            <h4
                style="margin-top: 0; margin-bottom: 1.5rem; color: var(--secondary); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                <i class="fas fa-address-book"></i> Contact Details
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Student
                        Phone *</label>
                    <input type="tel" name="phone" value="{{ student.phone if student else '' }}" required
                        placeholder="98XXXXXXXX">
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Emergency
                        Contact</label>
                    <input type="tel" name="emergency_contact"
                        value="{{ student.emergency_contact if student else '' }}" placeholder="Sister/Brother/etc.">
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">Guardian
                        Name</label>
                    <input type="text" name="guardian_name" value="{{ student.guardian_name if student else '' }}"
                        placeholder="Parent's Name">
                </div>
            </div>
        </div>

        <!-- Section 3: Financials -->
        <div class="glass-card" style="padding: 2rem;">
            <h4
                style="margin-top: 0; margin-bottom: 1.5rem; color: #10b981; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                <i class="fas fa-coins"></i> Financial Settings
            </h4>

            <div
                style="background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 12px; border: 1px dashed var(--border);">
                <label
                    style="display: block; margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;">
                    Monthly Fee Calculation
                </label>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                    <!-- Base Fee (Hidden or Readonly representation if needed, but we just need final) -->

                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Admission
                            Fee (One-Time)</label>
                        <div style="position: relative;">
                            <span
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">Rs</span>
                            <input type="number" name="custom_admission_fee"
                                value="{{ student.custom_admission_fee if student and student.custom_admission_fee is not none else '1000' }}"
                                step="1" style="padding-left: 2.5rem; background: rgba(255,255,255,0.05);">
                        </div>
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Base
                            Monthly Fee</label>
                        <div style="position: relative;">
                            <span
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">Rs</span>
                            <input type="number" name="base_monthly_fee" id="base_fee"
                                value="{{ student.base_monthly_fee if student else site_settings.default_monthly_fee }}"
                                oninput="calculateMonthlyFee()"
                                style="padding-left: 2.5rem; background: rgba(255,255,255,0.05);">
                        </div>
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Monthly
                            Discount (%)</label>
                        <div style="position: relative;">
                            <input type="number" name="admission_discount_percent" id="discount_percent"
                                value="{{ student.admission_discount_percent if student else '0' }}" min="0" max="100"
                                step="1" oninput="calculateMonthlyFee()" placeholder="0">
                            <span
                                style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">%</span>
                        </div>
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: #10b981; font-size: 0.8rem; font-weight: bold;">Final
                            Monthly Fee</label>
                        <div style="position: relative;">
                            <span
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #10b981;">Rs</span>
                            <input type="number" name="custom_monthly_fee" id="final_fee"
                                value="{{ student.custom_monthly_fee if student else '5000' }}" step="1"
                                style="padding-left: 2.5rem; font-size: 1.1rem; font-weight: 600; border-color: #10b981;">
                        </div>
                    </div>
                </div>

                <script>
                    function calculateMonthlyFee() {
                        const baseFeeInput = document.getElementById('base_fee');
                        const discountInput = document.getElementById('discount_percent');
                        const finalFeeInput = document.getElementById('final_fee');

                        let baseFee = parseFloat(baseFeeInput.value) || 0;
                        let discount = parseFloat(discountInput.value) || 0;

                        if (discount > 100) discount = 100;
                        if (discount < 0) discount = 0;

                        const finalFee = baseFee * (1 - discount / 100);
                        finalFeeInput.value = Math.round(finalFee);
                    }
                </script>
            </div>

            {% if student and student.status == 'Inactive' %}
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <label class="checkbox-container"
                    style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                    <input type="checkbox" name="charge_readmission" value="yes" style="width: 1.2rem; height: 1.2rem;">
                    <span style="color: var(--warning);">Charge Re-admission Fee? (50% of Admission)</span>
                </label>
            </div>
            {% endif %}
        </div>
</div>

<!-- Buttons -->
<div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
    <a href="{{ url_for('students.index') }}"
        style="padding: 1rem 2rem; color: var(--text-muted); text-decoration: none; font-weight: 500;">Cancel</a>
    <button type="submit" class="btn-primary"
        style="padding: 1rem 3rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-check"></i> {{ 'Save Changes' if student else 'Register Student' }}
    </button>
</div>

</form>
</div>
{% endblock %}